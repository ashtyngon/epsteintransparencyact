name: Fetch & Generate Articles

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  fetch-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Kill entire job if it exceeds 15 minutes
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch RSS feeds
        run: npx tsx scripts/fetch-rss.ts
        timeout-minutes: 2

      - name: Filter with Claude Haiku
        run: npx tsx scripts/filter-articles.ts
        timeout-minutes: 3
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Generate articles with Claude Sonnet
        run: npx tsx scripts/generate-article.ts
        timeout-minutes: 5
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Edit and fact-check articles
        run: npx tsx scripts/edit-article.ts
        timeout-minutes: 6
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Cross-link people and article mentions
        run: npx tsx scripts/cross-link.ts
        timeout-minutes: 1

      - name: Clean up temp files
        run: |
          rm -f scripts/config/candidates.json
          rm -f scripts/config/relevant.json

      - name: Commit and push new articles
        run: |
          git config user.name "Article Bot"
          git config user.email "bot@epsteintransparencyact.com"
          git add src/content/articles/ scripts/config/processed-urls.json
          git diff --staged --quiet || git commit -m "auto: add new articles $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git pull --rebase origin main || true
          git push
