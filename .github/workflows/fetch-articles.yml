name: Fetch & Generate Articles

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  fetch-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Kill entire job if it exceeds 15 minutes
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch RSS feeds
        run: npx tsx scripts/fetch-rss.ts
        timeout-minutes: 2

      - name: Filter with Claude Haiku
        run: npx tsx scripts/filter-articles.ts
        timeout-minutes: 5
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Generate articles with Claude Sonnet
        run: npx tsx scripts/generate-article.ts
        timeout-minutes: 5
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Edit articles (style + structure)
        run: npx tsx scripts/edit-article.ts
        timeout-minutes: 6
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      # Fix #16: Blind fact-check pass (Haiku — sees only article body, not source)
      - name: Fact-check articles (blind Haiku pass)
        run: npx tsx scripts/fact-check-article.ts
        timeout-minutes: 3
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Cross-link people and article mentions
        run: npx tsx scripts/cross-link.ts
        timeout-minutes: 1

      - name: Clean up temp files
        run: |
          rm -f scripts/config/candidates.json
          rm -f scripts/config/relevant.json

      - name: Commit and push new articles
        run: |
          git config user.name "Article Bot"
          git config user.email "bot@epsteintransparencyact.com"

          # Stage ALL tracked changes in content + config (catches cross-link edits, topics, health, etc.)
          git add src/content/articles/ scripts/config/processed-urls.json scripts/config/article-topics.json scripts/config/feed-health.json

          # Bail early if nothing to commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "auto: add new articles $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Push with retry — stash any unstaged leftovers so rebase can work
          for i in 1 2 3; do
            # Stash unstaged changes (if any) so rebase doesn't choke
            STASHED=false
            if ! git diff --quiet 2>/dev/null; then
              git stash --include-untracked && STASHED=true
            fi

            if git pull --rebase origin main; then
              # Restore stash if we stashed
              [ "$STASHED" = true ] && git stash pop || true
              git push && echo "Push succeeded on attempt $i" && exit 0
            fi

            # Restore stash on rebase failure too
            [ "$STASHED" = true ] && git stash pop || true

            echo "Push attempt $i failed, retrying in 5s..."
            sleep 5
          done

          echo "ERROR: All 3 push attempts failed"
          exit 1
