---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedArticles from '../components/RelatedArticles.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { personJsonLd } from '../utils/json-ld';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';

interface Props {
  person: CollectionEntry<'people'>;
  headings?: MarkdownHeading[];
}

const { person, headings = [] } = Astro.props;
const { name, seoTitle, seoDescription, role, category, shortBio, aliases, notableConnections, sources, image } = person.data;

// SEO: keyword-rich title and description for search
const pageTitle = seoTitle || `${name} & Jeffrey Epstein â€” Connection, Files & Documents`;
const pageDescription = seoDescription || `${name}'s documented connections to Jeffrey Epstein. ${shortBio.slice(0, 130)}${shortBio.length > 130 ? '...' : ''}`;

const categoryLabels: Record<string, string> = {
  'named-in-documents': 'Named in Documents',
  witness: 'Witness',
  associate: 'Associate',
  official: 'Official',
  legal: 'Legal',
  'victim-survivor': 'Victim/Survivor',
  other: 'Other',
};

const categoryColors: Record<string, string> = {
  'named-in-documents': 'bg-highlight text-white',
  witness: 'bg-amber-600 text-white',
  associate: 'bg-red-700 text-white',
  official: 'bg-blue-700 text-white',
  legal: 'bg-purple-700 text-white',
  'victim-survivor': 'bg-emerald-700 text-white',
  other: 'bg-gray-600 text-white',
};

const initials = name.split(' ').map((n: string) => n[0]).join('').slice(0, 2);

const jsonLd = personJsonLd({
  name,
  shortBio,
  role,
  slug: person.id,
  image,
  sources,
});
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  ogType="profile"
  ogImage={`/og/people/${person.id}.png`}
  jsonLd={jsonLd}
>
  <!-- Person header -->
  <header class="bg-primary text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
      <Breadcrumbs items={[
        { name: 'People', href: '/people' },
        { name, href: `/people/${person.id}` },
      ]} />
    </div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 pb-10">
      <div class="flex gap-6 items-start">
        {/* Photo */}
        <div class="flex-shrink-0 hidden sm:block">
          {image ? (
            <img
              src={image}
              alt={name}
              class="w-28 h-28 md:w-36 md:h-36 object-cover rounded-full border-2 border-white/20"
            />
          ) : (
            <div class="w-28 h-28 md:w-36 md:h-36 rounded-full bg-white/10 flex items-center justify-center border-2 border-white/20">
              <span class="text-3xl md:text-4xl font-bold text-white/30">{initials}</span>
            </div>
          )}
        </div>

        <div class="flex-1">
          <div class="flex items-center gap-2 mb-4">
            <span class:list={[
              'text-[10px] font-semibold uppercase tracking-wider px-2 py-0.5',
              categoryColors[category] || 'bg-gray-600 text-white',
            ]}>
              {categoryLabels[category] || category}
            </span>
          </div>

          {/* Mobile photo */}
          {image && (
            <div class="sm:hidden mb-4">
              <img
                src={image}
                alt={name}
                class="w-24 h-24 object-cover rounded-full border-2 border-white/20"
              />
            </div>
          )}

          <h1 class="text-3xl md:text-[2.75rem] font-serif font-bold leading-[1.15] mb-3">
            {name}
          </h1>
          <p class="text-sm font-semibold uppercase tracking-wider text-white/50 mb-4">{role}</p>
          <p class="text-base md:text-lg text-white/60 leading-relaxed max-w-2xl">{shortBio}</p>

          {aliases.length > 0 && (
            <div class="mt-4 text-xs text-white/40">
              <span class="font-semibold uppercase tracking-wider">Also known as:</span>
              <span class="ml-1 font-mono">{aliases.join(', ')}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="max-w-3xl mx-auto px-4 sm:px-6 py-10">
    <TableOfContents headings={headings} minHeadings={4} />
    <div class="prose-article">
      <slot />
    </div>

    <!-- Notable connections -->
    {notableConnections.length > 0 && (
      <div class="mt-10 pt-8 border-t-2 border-primary">
        <h2 class="text-sm font-semibold uppercase tracking-wider text-primary mb-4">Notable Connections</h2>
        <div class="flex flex-wrap gap-2">
          {notableConnections.map((slug) => (
            <a
              href={`/people/${slug}`}
              class="text-sm font-medium text-primary border border-border px-3 py-1.5 hover:border-accent hover:text-accent transition-colors no-underline"
            >
              {slug.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase())}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Related articles -->
    <div class="mt-8">
      <RelatedArticles personSlug={person.id} />
    </div>

    <!-- Sources -->
    {sources.length > 0 && (
      <div class="mt-8 pt-6 border-t border-border">
        <h2 class="text-sm font-semibold uppercase tracking-wider text-primary mb-4">Sources</h2>
        <ul class="space-y-2">
          {sources.map((s) => (
            <li>
              <a
                href={s.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-accent hover:text-primary transition-colors"
              >
                {s.title} &rarr;
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </div>
</BaseLayout>
