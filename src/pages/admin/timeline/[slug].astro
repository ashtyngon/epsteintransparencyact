---
export const prerender = false;

import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { getContentFile, updateFile, deleteFile, buildMarkdownContent } from '../../../lib/github';
import { getEnv } from '../../../lib/env';

const user = (Astro.locals as any).user;
const cfEnv = getEnv(Astro.locals);
const repo = cfEnv.GITHUB_REPO;
const token = user?.githubToken || '';

const { slug } = Astro.params;
let message = '';
let messageType = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('_action') as string;

  if (action === 'save') {
    const file = await getContentFile(token, repo, 'timeline', slug!);
    if (file) {
      const fm = { ...file.frontmatter };
      fm.title = formData.get('title') as string || fm.title;
      fm.date = formData.get('date') as string || fm.date;
      fm.era = formData.get('era') as string || fm.era;
      fm.category = formData.get('category') as string || fm.category;
      fm.significance = formData.get('significance') as string || fm.significance;
      fm.summary = formData.get('summary') as string || fm.summary;
      fm.order = parseInt(formData.get('order') as string || '0', 10);

      const endDate = formData.get('endDate') as string || '';
      if (endDate) fm.endDate = endDate;
      else delete fm.endDate;

      const image = formData.get('image') as string || '';
      if (image) fm.image = image;
      else delete fm.image;

      const imageCaption = formData.get('imageCaption') as string || '';
      if (imageCaption) fm.imageCaption = imageCaption;
      else delete fm.imageCaption;

      const peopleStr = formData.get('people') as string || '';
      fm.people = peopleStr.split(',').map((p: string) => p.trim()).filter(Boolean);

      const relatedArticlesStr = formData.get('relatedArticles') as string || '';
      fm.relatedArticles = relatedArticlesStr.split(',').map((r: string) => r.trim()).filter(Boolean);

      const relatedEventsStr = formData.get('relatedEvents') as string || '';
      fm.relatedEvents = relatedEventsStr.split(',').map((r: string) => r.trim()).filter(Boolean);

      // Parse sources (title|url per line)
      const sourcesStr = formData.get('sources') as string || '';
      fm.sources = sourcesStr.split('\n')
        .map((line: string) => line.trim())
        .filter(Boolean)
        .map((line: string) => {
          const parts = line.split('|').map((p: string) => p.trim());
          return parts.length >= 2 ? { title: parts[0], url: parts[1] } : null;
        })
        .filter(Boolean);

      const body = formData.get('body') as string || file.body;
      const content = buildMarkdownContent(fm, body);
      const ok = await updateFile(token, repo, file.path, content, file.sha, `cms: edit timeline ${slug}`);
      message = ok ? 'Saved successfully.' : 'Failed to save.';
      messageType = ok ? 'success' : 'error';
    }
  }

  if (action === 'delete') {
    const file = await getContentFile(token, repo, 'timeline', slug!);
    if (file) {
      const ok = await deleteFile(token, repo, file.path, file.sha, `cms: delete timeline ${slug}`);
      if (ok) {
        return Astro.redirect('/admin/timeline/');
      }
      message = 'Failed to delete.';
      messageType = 'error';
    }
  }
}

const file = await getContentFile(token, repo, 'timeline', slug!);
if (!file) {
  return Astro.redirect('/admin/timeline/');
}

const fm = file.frontmatter;
const sourcesText = Array.isArray(fm.sources)
  ? fm.sources.map((s: any) => `${s.title}|${s.url}`).join('\n')
  : '';
---

<AdminLayout title={`Edit: ${fm.title || slug}`} activeNav="Timeline">
  {message && <div class={`alert alert-${messageType}`}>{message}</div>}

  <form method="POST">
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-2">
        <a href="/admin/timeline/" class="btn btn-secondary">&larr; Back</a>
        <a href={`/timeline/`} target="_blank" class="btn btn-secondary">View Timeline</a>
      </div>
      <div class="flex gap-2">
        <button type="submit" name="_action" value="save" class="btn btn-success">Save</button>
        <button type="submit" name="_action" value="delete" class="btn btn-danger btn-sm"
          onclick="return confirm('Delete this timeline event permanently?')">Delete</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="grid-2 gap-4">
        <div class="form-group" style="grid-column: span 2;">
          <label>Title</label>
          <input type="text" name="title" value={fm.title || ''} class="form-input" required />
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" name="date" value={String(fm.date || '').slice(0, 10)} class="form-input" required />
        </div>
        <div class="form-group">
          <label>End Date (optional, for ranges)</label>
          <input type="date" name="endDate" value={fm.endDate ? String(fm.endDate).slice(0, 10) : ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Era</label>
          <select name="era" class="form-input">
            <option value="origins" selected={fm.era === 'origins'}>Origins</option>
            <option value="first-prosecution" selected={fm.era === 'first-prosecution'}>First Prosecution</option>
            <option value="exposure" selected={fm.era === 'exposure'}>Exposure</option>
            <option value="reckoning" selected={fm.era === 'reckoning'}>Reckoning</option>
            <option value="aftermath" selected={fm.era === 'aftermath'}>Aftermath</option>
            <option value="transparency" selected={fm.era === 'transparency'}>Transparency</option>
          </select>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select name="category" class="form-input">
            <option value="biography" selected={fm.category === 'biography'}>Biography</option>
            <option value="legal" selected={fm.category === 'legal'}>Legal</option>
            <option value="document-release" selected={fm.category === 'document-release'}>Document Release</option>
            <option value="legislation" selected={fm.category === 'legislation'}>Legislation</option>
            <option value="investigation" selected={fm.category === 'investigation'}>Investigation</option>
            <option value="media" selected={fm.category === 'media'}>Media</option>
            <option value="civil-litigation" selected={fm.category === 'civil-litigation'}>Civil Litigation</option>
            <option value="network" selected={fm.category === 'network'}>Network</option>
            <option value="other" selected={fm.category === 'other'}>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Significance</label>
          <select name="significance" class="form-input">
            <option value="major" selected={fm.significance === 'major'}>Major</option>
            <option value="standard" selected={fm.significance === 'standard'}>Standard</option>
            <option value="minor" selected={fm.significance === 'minor'}>Minor</option>
          </select>
        </div>
        <div class="form-group">
          <label>Order</label>
          <input type="number" name="order" value={fm.order ?? 0} class="form-input" />
        </div>
        <div class="form-group">
          <label>Image Path</label>
          <input type="text" name="image" value={fm.image || ''} class="form-input" placeholder="/images/timeline/event.jpg" />
        </div>
        <div class="form-group">
          <label>Image Caption</label>
          <input type="text" name="imageCaption" value={fm.imageCaption || ''} class="form-input" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>Summary</label>
          <textarea name="summary" class="form-input" style="min-height: 80px;">{fm.summary || ''}</textarea>
        </div>
        <div class="form-group">
          <label>People (comma-separated slugs)</label>
          <input type="text" name="people" value={Array.isArray(fm.people) ? fm.people.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Related Articles (comma-separated slugs)</label>
          <input type="text" name="relatedArticles" value={Array.isArray(fm.relatedArticles) ? fm.relatedArticles.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>Related Events (comma-separated slugs)</label>
          <input type="text" name="relatedEvents" value={Array.isArray(fm.relatedEvents) ? fm.relatedEvents.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>Sources (one per line: title|url)</label>
          <textarea name="sources" class="form-input" style="min-height: 80px;"
            placeholder="Source Title|https://example.com/article">{sourcesText}</textarea>
        </div>
      </div>
    </div>

    <!-- Markdown Editor -->
    <div class="editor-container">
      <div class="editor-pane">
        <div class="editor-pane-header">Body (Markdown)</div>
        <textarea name="body" class="form-input" id="editor"
          style="min-height: 400px; flex: 1;">{file.body}</textarea>
      </div>
      <div class="editor-pane">
        <div class="editor-pane-header">Preview</div>
        <div class="preview-pane" id="preview"></div>
      </div>
    </div>
  </form>

  <script is:inline>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');

    function renderMarkdown(md) {
      let html = md
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/\n\n/g, '</p><p>');
      return '<p>' + html + '</p>';
    }

    function updatePreview() {
      preview.innerHTML = renderMarkdown(editor.value);
    }

    editor.addEventListener('input', updatePreview);
    updatePreview();
  </script>
</AdminLayout>
