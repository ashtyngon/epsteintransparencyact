---
export const prerender = false;

import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { getContentFile, updateFile, deleteFile, buildMarkdownContent } from '../../../lib/github';

const user = (Astro.locals as any).user;
const runtime = (Astro.locals as any).runtime;
const repo = runtime?.env?.GITHUB_REPO || import.meta.env.GITHUB_REPO || 'ashtyngon/epsteintransparencyact';
const token = user?.githubToken || '';

const { slug } = Astro.params;
let message = '';
let messageType = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('_action') as string;

  if (action === 'save') {
    const file = await getContentFile(token, repo, 'people', slug!);
    if (file) {
      const fm = { ...file.frontmatter };
      fm.name = formData.get('name') as string || fm.name;
      fm.seoTitle = formData.get('seoTitle') as string || '';
      fm.seoDescription = formData.get('seoDescription') as string || '';
      fm.role = formData.get('role') as string || fm.role;
      fm.category = formData.get('category') as string || fm.category;
      fm.shortBio = formData.get('shortBio') as string || fm.shortBio;
      fm.image = formData.get('image') as string || '';
      fm.sensitive = formData.get('sensitive') === 'true';

      const aliasesStr = formData.get('aliases') as string || '';
      fm.aliases = aliasesStr.split(',').map((a: string) => a.trim()).filter(Boolean);

      const connectionsStr = formData.get('notableConnections') as string || '';
      fm.notableConnections = connectionsStr.split(',').map((c: string) => c.trim()).filter(Boolean);

      const firstMentioned = formData.get('firstMentionedDate') as string || '';
      if (firstMentioned) fm.firstMentionedDate = firstMentioned;

      // Parse sources (title|url per line)
      const sourcesStr = formData.get('sources') as string || '';
      fm.sources = sourcesStr.split('\n')
        .map((line: string) => line.trim())
        .filter(Boolean)
        .map((line: string) => {
          const parts = line.split('|').map((p: string) => p.trim());
          return parts.length >= 2 ? { title: parts[0], url: parts[1] } : null;
        })
        .filter(Boolean);

      const body = formData.get('body') as string || file.body;
      const content = buildMarkdownContent(fm, body);
      const ok = await updateFile(token, repo, file.path, content, file.sha, `cms: edit person ${slug}`);
      message = ok ? 'Saved successfully.' : 'Failed to save.';
      messageType = ok ? 'success' : 'error';
    }
  }

  if (action === 'delete') {
    const file = await getContentFile(token, repo, 'people', slug!);
    if (file) {
      const ok = await deleteFile(token, repo, file.path, file.sha, `cms: delete person ${slug}`);
      if (ok) {
        return Astro.redirect('/admin/people/');
      }
      message = 'Failed to delete.';
      messageType = 'error';
    }
  }
}

const file = await getContentFile(token, repo, 'people', slug!);
if (!file) {
  return Astro.redirect('/admin/people/');
}

const fm = file.frontmatter;
const sourcesText = Array.isArray(fm.sources)
  ? fm.sources.map((s: any) => `${s.title}|${s.url}`).join('\n')
  : '';
---

<AdminLayout title={`Edit: ${fm.name || slug}`} activeNav="People">
  {message && <div class={`alert alert-${messageType}`}>{message}</div>}

  <form method="POST">
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-2">
        <a href="/admin/people/" class="btn btn-secondary">&larr; Back</a>
        <a href={`/people/${slug}/`} target="_blank" class="btn btn-secondary">View Live</a>
      </div>
      <div class="flex gap-2">
        <button type="submit" name="_action" value="save" class="btn btn-success">Save</button>
        <button type="submit" name="_action" value="delete" class="btn btn-danger btn-sm"
          onclick="return confirm('Delete this person permanently?')">Delete</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="grid-2 gap-4">
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" value={fm.name || ''} class="form-input" required />
        </div>
        <div class="form-group">
          <label>Role</label>
          <input type="text" name="role" value={fm.role || ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Category</label>
          <select name="category" class="form-input">
            <option value="named-in-documents" selected={fm.category === 'named-in-documents'}>Named in Documents</option>
            <option value="witness" selected={fm.category === 'witness'}>Witness</option>
            <option value="associate" selected={fm.category === 'associate'}>Associate</option>
            <option value="official" selected={fm.category === 'official'}>Official</option>
            <option value="legal" selected={fm.category === 'legal'}>Legal</option>
            <option value="victim-survivor" selected={fm.category === 'victim-survivor'}>Victim/Survivor</option>
            <option value="other" selected={fm.category === 'other'}>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Image Path</label>
          <input type="text" name="image" value={fm.image || ''} class="form-input" placeholder="/images/people/slug.jpg" />
        </div>
        <div class="form-group">
          <label>Aliases (comma-separated)</label>
          <input type="text" name="aliases" value={Array.isArray(fm.aliases) ? fm.aliases.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Notable Connections (comma-separated slugs)</label>
          <input type="text" name="notableConnections" value={Array.isArray(fm.notableConnections) ? fm.notableConnections.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>First Mentioned Date</label>
          <input type="date" name="firstMentionedDate" value={fm.firstMentionedDate || ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Sensitive</label>
          <select name="sensitive" class="form-input">
            <option value="false" selected={!fm.sensitive}>No</option>
            <option value="true" selected={fm.sensitive === true}>Yes</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>SEO Title</label>
          <input type="text" name="seoTitle" value={fm.seoTitle || ''} class="form-input" placeholder="Optional custom page title" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>SEO Description</label>
          <input type="text" name="seoDescription" value={fm.seoDescription || ''} class="form-input" placeholder="Optional meta description" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>Short Bio</label>
          <textarea name="shortBio" class="form-input" style="min-height: 100px;">{fm.shortBio || ''}</textarea>
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>Sources (one per line: title|url)</label>
          <textarea name="sources" class="form-input" style="min-height: 100px;"
            placeholder="Source Title|https://example.com/article">{sourcesText}</textarea>
        </div>
      </div>
    </div>

    <!-- Markdown Editor for profile body -->
    <div class="editor-container">
      <div class="editor-pane">
        <div class="editor-pane-header">Profile Body (Markdown)</div>
        <textarea name="body" class="form-input" id="editor"
          style="min-height: 500px; flex: 1;">{file.body}</textarea>
      </div>
      <div class="editor-pane">
        <div class="editor-pane-header">Preview</div>
        <div class="preview-pane" id="preview"></div>
      </div>
    </div>
  </form>

  <script is:inline>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');

    function renderMarkdown(md) {
      let html = md
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/\n\n/g, '</p><p>');
      return '<p>' + html + '</p>';
    }

    function updatePreview() {
      preview.innerHTML = renderMarkdown(editor.value);
    }

    editor.addEventListener('input', updatePreview);
    updatePreview();
  </script>
</AdminLayout>
