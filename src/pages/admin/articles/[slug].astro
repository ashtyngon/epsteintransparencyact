---
export const prerender = false;

import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { getContentFile, updateFile, deleteFile, buildMarkdownContent } from '../../../lib/github';
import { getEnv } from '../../../lib/env';

const user = (Astro.locals as any).user;
const cfEnv = getEnv(Astro.locals);
const repo = cfEnv.GITHUB_REPO;
const token = user?.githubToken || '';

const { slug } = Astro.params;
let message = '';
let messageType = '';

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('_action') as string;

  if (action === 'save' || action === 'publish') {
    const file = await getContentFile(token, repo, 'articles', slug!);
    if (file) {
      const fm = { ...file.frontmatter };
      fm.title = formData.get('title') as string || fm.title;
      fm.source = formData.get('source') as string || fm.source;
      fm.sourceUrl = formData.get('sourceUrl') as string || fm.sourceUrl;
      fm.status = action === 'publish' ? 'published' : (formData.get('status') as string || fm.status);
      fm.articleType = formData.get('articleType') as string || fm.articleType;

      const tagsStr = formData.get('tags') as string || '';
      fm.tags = tagsStr.split(',').map((t: string) => t.trim()).filter(Boolean);

      const peopleStr = formData.get('people') as string || '';
      fm.people = peopleStr.split(',').map((p: string) => p.trim()).filter(Boolean);

      const body = formData.get('body') as string || file.body;
      const content = buildMarkdownContent(fm, body);
      const commitMsg = action === 'publish'
        ? `cms: publish ${slug}`
        : `cms: edit ${slug}`;

      const ok = await updateFile(token, repo, file.path, content, file.sha, commitMsg);
      message = ok ? 'Saved successfully.' : 'Failed to save.';
      messageType = ok ? 'success' : 'error';
    }
  }

  if (action === 'delete') {
    const file = await getContentFile(token, repo, 'articles', slug!);
    if (file) {
      const ok = await deleteFile(token, repo, file.path, file.sha, `cms: delete ${slug}`);
      if (ok) {
        return Astro.redirect('/admin/articles/');
      }
      message = 'Failed to delete.';
      messageType = 'error';
    }
  }
}

const file = await getContentFile(token, repo, 'articles', slug!);
if (!file) {
  return Astro.redirect('/admin/articles/');
}

const fm = file.frontmatter;
---

<AdminLayout title={`Edit: ${fm.title || slug}`} activeNav="Articles">
  {message && <div class={`alert alert-${messageType}`}>{message}</div>}

  <form method="POST">
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-2">
        <a href="/admin/articles/" class="btn btn-secondary">&larr; Back</a>
        <a href={`/news/${slug}/`} target="_blank" class="btn btn-secondary">View Live</a>
      </div>
      <div class="flex gap-2">
        <button type="submit" name="_action" value="save" class="btn btn-secondary">Save Draft</button>
        <button type="submit" name="_action" value="publish" class="btn btn-success">Publish</button>
        <button type="submit" name="_action" value="delete" class="btn btn-danger btn-sm"
          onclick="return confirm('Delete this article permanently?')">Delete</button>
      </div>
    </div>

    <!-- Frontmatter fields -->
    <div class="card mb-4">
      <div class="grid-2 gap-4">
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="title" value={fm.title || ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Source</label>
          <input type="text" name="source" value={fm.source || ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Source URL</label>
          <input type="url" name="sourceUrl" value={fm.sourceUrl || ''} class="form-input" />
        </div>
        <div class="form-group">
          <label>Status</label>
          <select name="status" class="form-input">
            <option value="published" selected={fm.status === 'published'}>Published</option>
            <option value="review" selected={fm.status === 'review'}>Review</option>
            <option value="draft" selected={fm.status === 'draft'}>Draft</option>
            <option value="unpublished" selected={fm.status === 'unpublished'}>Unpublished</option>
          </select>
        </div>
        <div class="form-group">
          <label>Article Type</label>
          <select name="articleType" class="form-input">
            <option value="news" selected={fm.articleType === 'news'}>News</option>
            <option value="feature" selected={fm.articleType === 'feature'}>Feature</option>
            <option value="analysis" selected={fm.articleType === 'analysis'}>Analysis</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" name="tags" value={Array.isArray(fm.tags) ? fm.tags.join(', ') : ''} class="form-input" />
        </div>
        <div class="form-group" style="grid-column: span 2;">
          <label>People (comma-separated slugs)</label>
          <input type="text" name="people" value={Array.isArray(fm.people) ? fm.people.join(', ') : ''} class="form-input" />
        </div>
      </div>
    </div>

    <!-- Markdown Editor -->
    <div class="editor-container">
      <div class="editor-pane">
        <div class="editor-pane-header">Markdown</div>
        <textarea name="body" class="form-input" id="editor"
          style="min-height: 500px; flex: 1;">{file.body}</textarea>
      </div>
      <div class="editor-pane">
        <div class="editor-pane-header">Preview</div>
        <div class="preview-pane" id="preview"></div>
      </div>
    </div>
  </form>

  <script is:inline>
    // Simple markdown preview (basic rendering)
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');

    function renderMarkdown(md) {
      let html = md
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      return '<p>' + html + '</p>';
    }

    function updatePreview() {
      preview.innerHTML = renderMarkdown(editor.value);
    }

    editor.addEventListener('input', updatePreview);
    updatePreview();
  </script>
</AdminLayout>
