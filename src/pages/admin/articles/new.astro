---
export const prerender = false;

import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { createFile, buildMarkdownContent } from '../../../lib/github';

const user = (Astro.locals as any).user;
const runtime = (Astro.locals as any).runtime;
const repo = runtime?.env?.GITHUB_REPO || import.meta.env.GITHUB_REPO || 'ashtyngon/epsteintransparencyact';
const token = user?.githubToken || '';

let message = '';
let messageType = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const title = formData.get('title') as string;
  const source = formData.get('source') as string || 'Editorial';
  const sourceUrl = formData.get('sourceUrl') as string || '';
  const status = formData.get('status') as string || 'draft';
  const articleType = formData.get('articleType') as string || 'news';
  const tagsStr = formData.get('tags') as string || '';
  const peopleStr = formData.get('people') as string || '';
  const body = formData.get('body') as string || '';

  if (!title) {
    message = 'Title is required.';
    messageType = 'error';
  } else {
    const date = new Date().toISOString().split('T')[0];
    const slugPart = title
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '')
      .slice(0, 80);
    const slug = `${date}-${slugPart}`;

    const fm: Record<string, any> = {
      title,
      publishedAt: new Date().toISOString(),
      source,
      sourceUrl,
      summary: body.replace(/[#*\[\]()]/g, '').replace(/\n+/g, ' ').trim().slice(0, 160),
      people: peopleStr.split(',').map((p: string) => p.trim()).filter(Boolean),
      tags: tagsStr.split(',').map((t: string) => t.trim()).filter(Boolean),
      status,
      aiGenerated: false,
      articleType,
      confidence: 1.0,
    };

    const content = buildMarkdownContent(fm, body);
    const path = `src/content/articles/${slug}.md`;
    const ok = await createFile(token, repo, path, content, `cms: create ${slug}`);

    if (ok) {
      return Astro.redirect(`/admin/articles/${slug}/`);
    }
    message = 'Failed to create article. It may already exist.';
    messageType = 'error';
  }
}
---

<AdminLayout title="New Article" activeNav="Articles">
  {message && <div class={`alert alert-${messageType}`}>{message}</div>}

  <form method="POST">
    <div class="flex justify-between items-center mb-4">
      <a href="/admin/articles/" class="btn btn-secondary">&larr; Back</a>
      <div class="flex gap-2">
        <button type="submit" name="status" value="draft" class="btn btn-secondary">Save as Draft</button>
        <button type="submit" name="status" value="published" class="btn btn-success">Publish</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="grid-2 gap-4">
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="title" class="form-input" required />
        </div>
        <div class="form-group">
          <label>Source</label>
          <input type="text" name="source" value="Editorial" class="form-input" />
        </div>
        <div class="form-group">
          <label>Source URL</label>
          <input type="url" name="sourceUrl" class="form-input" />
        </div>
        <div class="form-group">
          <label>Article Type</label>
          <select name="articleType" class="form-input">
            <option value="news">News</option>
            <option value="feature">Feature</option>
            <option value="analysis">Analysis</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" name="tags" class="form-input" />
        </div>
        <div class="form-group">
          <label>People (comma-separated slugs)</label>
          <input type="text" name="people" class="form-input" />
        </div>
      </div>
    </div>

    <div class="editor-container">
      <div class="editor-pane">
        <div class="editor-pane-header">Markdown</div>
        <textarea name="body" class="form-input" id="editor"
          style="min-height: 500px;" placeholder="Write your article here..."></textarea>
      </div>
      <div class="editor-pane">
        <div class="editor-pane-header">Preview</div>
        <div class="preview-pane" id="preview"></div>
      </div>
    </div>
  </form>

  <script is:inline>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');

    function renderMarkdown(md) {
      let html = md
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/\n\n/g, '</p><p>');
      return '<p>' + html + '</p>';
    }

    function updatePreview() {
      preview.innerHTML = renderMarkdown(editor.value);
    }

    editor.addEventListener('input', updatePreview);
  </script>
</AdminLayout>
