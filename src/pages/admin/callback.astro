---
export const prerender = false;

import { exchangeCodeForToken, getGitHubUser, checkRepoAccess, createSession, setSessionCookie } from '../../lib/auth';
import { getEnv } from '../../lib/env';

const code = Astro.url.searchParams.get('code');
if (!code) {
  return Astro.redirect('/admin/login/');
}

const cfEnv = getEnv(Astro.locals);
const clientId = cfEnv.GITHUB_CLIENT_ID;
const clientSecret = cfEnv.GITHUB_CLIENT_SECRET;
const repo = cfEnv.GITHUB_REPO;
const kv = cfEnv.ADMIN_SESSIONS;

let error = '';
let debugSteps: string[] = [];

debugSteps.push(`clientId: ${clientId ? clientId.slice(0, 6) + '...' : 'EMPTY'}`);
debugSteps.push(`clientSecret: ${clientSecret ? clientSecret.slice(0, 4) + '...' : 'EMPTY'}`);
debugSteps.push(`code: ${code ? code.slice(0, 6) + '...' : 'EMPTY'}`);

// Exchange code for token — inline for better error reporting
let token: string | null = null;
try {
  const tokenRes = await fetch('https://github.com/login/oauth/access_token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
    body: JSON.stringify({ client_id: clientId, client_secret: clientSecret, code }),
  });
  const tokenData = await tokenRes.json() as any;
  token = tokenData.access_token || null;
  debugSteps.push(`token exchange status: ${tokenRes.status}`);
  debugSteps.push(`token received: ${token ? 'yes' : 'no'}`);
  if (tokenData.error) {
    debugSteps.push(`github error: ${tokenData.error} — ${tokenData.error_description || ''}`);
  }
} catch (e: any) {
  debugSteps.push(`token exchange threw: ${e.message}`);
}

if (!token) {
  error = 'Failed to authenticate with GitHub.';
}

// Get user info
let user = null;
if (token) {
  user = await getGitHubUser(token);
  debugSteps.push(`user info: ${user ? user.login : 'FAILED'}`);
  if (!user) {
    error = 'Failed to get user information from GitHub.';
  }
}

// Check repo access
if (token && user) {
  const hasAccess = await checkRepoAccess(token, repo);
  if (!hasAccess) {
    error = `Access denied. ${user.login} is not a collaborator on ${repo}.`;
  }
}

// Create session
if (token && user && !error && kv) {
  const sessionId = await createSession(kv, user, token);
  return new Response(null, {
    status: 302,
    headers: {
      Location: '/admin/',
      'Set-Cookie': setSessionCookie(sessionId),
    },
  });
}

// If no KV (dev mode), redirect with a dev session
if (token && user && !error && !kv && import.meta.env.DEV) {
  return Astro.redirect('/admin/');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auth Error — Admin</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 40px; max-width: 420px; text-align: center; }
    .card h1 { color: #ef4444; font-size: 18px; margin-bottom: 12px; }
    .card p { color: #94a3b8; font-size: 14px; margin-bottom: 20px; }
    .card a { color: #f97316; text-decoration: none; font-weight: 600; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Authentication Error</h1>
    <p>{error || 'An unknown error occurred.'}</p>
    <p style="font-size: 11px; color: #475569; text-align: left; margin-top: 16px; word-break: break-all;">
      {debugSteps.map(s => <span>{s}<br/></span>)}
    </p>
    <a href="/admin/login/">Try again</a>
  </div>
</body>
</html>
