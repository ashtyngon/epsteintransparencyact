---
export const prerender = false;

import { exchangeCodeForToken, getGitHubUser, checkRepoAccess, createSession, setSessionCookie } from '../../lib/auth';

const code = Astro.url.searchParams.get('code');
if (!code) {
  return Astro.redirect('/admin/login/');
}

const runtime = (Astro.locals as any).runtime;
const clientId = runtime?.env?.GITHUB_CLIENT_ID || import.meta.env.GITHUB_CLIENT_ID || '';
const clientSecret = runtime?.env?.GITHUB_CLIENT_SECRET || import.meta.env.GITHUB_CLIENT_SECRET || '';
const repo = runtime?.env?.GITHUB_REPO || import.meta.env.GITHUB_REPO || 'ashtyngon/epsteintransparencyact';
const kv = runtime?.env?.ADMIN_SESSIONS;

let error = '';

// Exchange code for token
const token = await exchangeCodeForToken(code, clientId, clientSecret);
if (!token) {
  error = 'Failed to authenticate with GitHub. Please try again.';
}

// Get user info
let user = null;
if (token) {
  user = await getGitHubUser(token);
  if (!user) {
    error = 'Failed to get user information from GitHub.';
  }
}

// Check repo access
if (token && user) {
  const hasAccess = await checkRepoAccess(token, repo);
  if (!hasAccess) {
    error = `Access denied. ${user.login} is not a collaborator on ${repo}.`;
  }
}

// Create session
if (token && user && !error && kv) {
  const sessionId = await createSession(kv, user, token);
  return new Response(null, {
    status: 302,
    headers: {
      Location: '/admin/',
      'Set-Cookie': setSessionCookie(sessionId),
    },
  });
}

// If no KV (dev mode), redirect with a dev session
if (token && user && !error && !kv && import.meta.env.DEV) {
  return Astro.redirect('/admin/');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auth Error â€” Admin</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 40px; max-width: 420px; text-align: center; }
    .card h1 { color: #ef4444; font-size: 18px; margin-bottom: 12px; }
    .card p { color: #94a3b8; font-size: 14px; margin-bottom: 20px; }
    .card a { color: #f97316; text-decoration: none; font-weight: 600; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Authentication Error</h1>
    <p>{error || 'An unknown error occurred.'}</p>
    <a href="/admin/login/">Try again</a>
  </div>
</body>
</html>
