---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import EraSection from '../../components/timeline/EraSection.astro';
import TimelineNav from '../../components/timeline/TimelineNav.astro';
import CategoryFilter from '../../components/timeline/CategoryFilter.astro';
import { getCollection } from 'astro:content';
import { ERAS } from '../../utils/timeline-eras';
import { timelineJsonLd } from '../../utils/json-ld';

const entries = (await getCollection('timeline'))
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime() || a.data.order - b.data.order);

// Group by era
const entriesByEra = ERAS.map((era) => ({
  era,
  entries: entries.filter((e) => e.data.era === era.id),
})).filter((group) => group.entries.length > 0);

// Get unique categories for filter
const allCategories = [...new Set(entries.map((e) => e.data.category))].sort();

// Era counts for nav
const eraNavItems = entriesByEra.map((group) => ({
  era: group.era,
  count: group.entries.length,
}));

const jsonLd = timelineJsonLd(
  entries.map((e) => ({
    title: e.data.title,
    date: e.data.date,
    summary: e.data.summary,
  }))
);
---

<BaseLayout
  title="The Epstein Case: A Complete Timeline"
  description="A comprehensive chronological record of key events, court proceedings, investigations, and legislative milestones in the Jeffrey Epstein case."
  jsonLd={jsonLd}
>
  <!-- Page Header -->
  <header class="bg-primary text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
      <Breadcrumbs items={[
        { name: 'Timeline', href: '/timeline' },
      ]} />
    </div>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 pb-10">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-[10px] font-semibold uppercase tracking-wider px-2 py-0.5 bg-highlight text-white">
          Chronology
        </span>
        <span class="text-xs text-white/50 font-mono">{entries.length} events</span>
      </div>
      <h1 class="text-3xl md:text-[2.75rem] font-serif font-bold leading-[1.15] mb-3">
        The Epstein Case: A Complete Timeline
      </h1>
      <p class="text-base md:text-lg text-white/60 leading-relaxed max-w-3xl">
        From the origins of Epstein's financial empire to the landmark transparency legislation â€”
        every major event, court proceeding, and investigation documented.
      </p>
    </div>
  </header>

  <!-- Content -->
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">
    <!-- Era Navigation -->
    <TimelineNav eras={eraNavItems} />

    <!-- Category Filter -->
    <CategoryFilter categories={allCategories} />

    <!-- Era Sections -->
    {entriesByEra.map((group) => (
      <EraSection era={group.era} entries={group.entries} />
    ))}

    {entries.length === 0 && (
      <div class="text-center py-16">
        <p class="text-text-muted text-lg">Timeline is being compiled.</p>
        <p class="text-text-muted text-sm mt-2">
          A comprehensive chronological record will be available here soon.
        </p>
      </div>
    )}
  </div>
</BaseLayout>
