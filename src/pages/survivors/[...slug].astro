---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import SurvivorNotice from '../../components/SurvivorNotice.astro';
import RelatedPeople from '../../components/RelatedPeople.astro';
import { getCollection, render } from 'astro:content';
import { formatDate } from '../../utils/slugify';

export async function getStaticPaths() {
  const entries = await getCollection('survivors');
  return entries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { title, publishedAt, type, source, sourceUrl, contentWarning, people } = entry.data;
const { Content } = await render(entry);
---

<BaseLayout title={title} description={`Survivor ${type}: ${title}`}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <Breadcrumbs items={[
      { name: 'Survivors', href: '/survivors' },
      { name: title, href: `/survivors/${entry.id}` },
    ]} />

    <SurvivorNotice contentWarning={contentWarning} />

    <article>
      <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-primary leading-tight mb-4">
          {title}
        </h1>
        <div class="flex flex-wrap items-center gap-3 text-sm text-text-muted">
          <time datetime={publishedAt.toISOString()}>{formatDate(publishedAt)}</time>
          {source && (
            <>
              <span class="text-border">|</span>
              {sourceUrl ? (
                <a href={sourceUrl} target="_blank" rel="noopener noreferrer" class="text-accent hover:underline">
                  {source}
                </a>
              ) : (
                <span>{source}</span>
              )}
            </>
          )}
          <span class="text-border">|</span>
          <span class="text-xs bg-surface px-2 py-0.5 rounded">{type}</span>
        </div>
      </header>

      <div class="prose prose-lg max-w-none">
        <Content />
      </div>

      {people.length > 0 && (
        <div class="mt-8">
          <RelatedPeople slugs={people} />
        </div>
      )}
    </article>
  </div>
</BaseLayout>
