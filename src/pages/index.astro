---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';
import { websiteJsonLd } from '../utils/json-ld';
import { formatDateShort } from '../utils/slugify';
import { getEra, getEraCategoryLabel } from '../utils/timeline-eras';

const allArticles = (await getCollection('articles', (a) => a.data.status === 'published'))
  .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

const featuredArticle = allArticles[0];
const remainingArticles = allArticles.slice(1, 9);

const people = (await getCollection('people')).slice(0, 4);
const totalArticles = allArticles.length;

// Timeline preview — 4 most recent events
const timelineEntries = (await getCollection('timeline'))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 4);
---

<BaseLayout
  title="Home"
  description="Tracking every development around the Epstein Files and the Epstein Transparency Act. News from major outlets with full source attribution."
  jsonLd={websiteJsonLd()}
>
  <!-- Hero — compact, authoritative -->
  <section class="bg-primary text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 md:py-12">
      <div class="max-w-3xl">
        <div class="flex items-center gap-2 mb-4">
          <span class="breaking-tag">Active Investigation</span>
          <span class="text-xs text-white/40 font-mono">{totalArticles} articles tracked</span>
        </div>
        <h1 class="text-3xl md:text-5xl font-serif font-bold mb-3 leading-[1.15] tracking-tight">
          The Epstein Files: <br class="hidden md:block" />Every Document. Every Name. Every Update.
        </h1>
        <p class="text-base md:text-lg text-white/60 leading-relaxed max-w-2xl">
          We track every development around the Epstein Files and the Epstein Transparency Act.
          All reporting sourced from major outlets. No opinion. No noise. No spin.
        </p>
        <div class="flex flex-wrap gap-3 mt-6">
          <a
            href="/articles"
            class="bg-highlight text-white px-5 py-2.5 text-sm font-semibold hover:bg-highlight/90 transition-colors"
          >
            Latest News
          </a>
          <a
            href="/timeline"
            class="border border-white/20 text-white/80 px-5 py-2.5 text-sm font-semibold hover:bg-white/5 hover:text-white transition-colors"
          >
            View Timeline
          </a>
          <a
            href="/people"
            class="border border-white/20 text-white/80 px-5 py-2.5 text-sm font-semibold hover:bg-white/5 hover:text-white transition-colors"
          >
            People Database
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Latest news feed -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
    <!-- Section header -->
    <div class="flex items-center justify-between mb-6 border-b-2 border-primary pb-2">
      <h2 class="text-sm font-semibold uppercase tracking-wider text-primary">Latest Coverage</h2>
      <a href="/articles" class="text-xs font-semibold uppercase tracking-wider text-accent hover:text-primary transition-colors">
        All stories &rarr;
      </a>
    </div>

    {allArticles.length > 0 ? (
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main column: featured + articles -->
        <div class="lg:col-span-8">
          {/* Featured article */}
          {featuredArticle && (
            <ArticleCard article={featuredArticle} featured={true} />
          )}

          {/* Article list */}
          <div class="mt-6">
            {remainingArticles.map((article) => (
              <ArticleCard article={article} />
            ))}
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-4">
          <!-- People in the news -->
          {people.length > 0 && (
            <div class="mb-8">
              <div class="flex items-center justify-between mb-4 border-b-2 border-primary pb-2">
                <h3 class="text-sm font-semibold uppercase tracking-wider text-primary">Key People</h3>
                <a href="/people" class="text-xs font-semibold text-accent hover:text-primary transition-colors">
                  View all &rarr;
                </a>
              </div>
              <div class="space-y-3">
                {people.map((person) => (
                  <a
                    href={`/people/${person.id}`}
                    class="block group no-underline p-3 border border-border hover:border-accent/30 transition-colors"
                  >
                    <div class="flex items-start justify-between gap-2">
                      <div>
                        <h4 class="text-sm font-bold text-primary group-hover:text-accent transition-colors">
                          {person.data.name}
                        </h4>
                        <p class="text-xs text-text-muted mt-0.5">{person.data.role}</p>
                      </div>
                      <span class="text-[10px] font-semibold uppercase tracking-wider text-text-muted bg-surface-dark px-2 py-0.5">
                        {person.data.category.replace(/-/g, ' ')}
                      </span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Timeline preview -->
          <div class="bg-primary text-white p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xs font-semibold uppercase tracking-wider text-white/50">Timeline</h3>
              <a href="/timeline" class="text-xs font-semibold text-highlight hover:text-white transition-colors">
                Full timeline &rarr;
              </a>
            </div>
            {timelineEntries.length > 0 ? (
              <div class="space-y-0">
                {timelineEntries.map((entry) => {
                  const era = getEra(entry.data.era);
                  const catLabel = getEraCategoryLabel(entry.data.category);
                  return (
                    <a
                      href={`/timeline/${entry.id}`}
                      class="flex items-start gap-3 group no-underline py-2.5 border-b border-white/10 last:border-b-0"
                    >
                      <span class="w-1.5 h-1.5 flex-shrink-0 mt-[7px]" style={`background:${era.color}`}></span>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                          <span class="text-[10px] font-mono text-white/35">
                            {entry.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
                          </span>
                          <span class="text-[9px] font-semibold uppercase tracking-wider text-white/25">
                            {catLabel}
                          </span>
                        </div>
                        <h4 class="text-sm font-serif font-bold text-white/80 group-hover:text-white transition-colors leading-snug line-clamp-2">
                          {entry.data.title}
                        </h4>
                      </div>
                    </a>
                  );
                })}
              </div>
            ) : (
              <p class="text-sm text-white/50">Timeline coming soon.</p>
            )}
          </div>

          <!-- About teaser -->
          <div class="mt-6 p-5 border border-border">
            <h3 class="text-xs font-semibold uppercase tracking-wider text-primary mb-3">About This Site</h3>
            <p class="text-sm text-text-muted leading-relaxed">
              We aggregate reporting from major news outlets about the Epstein Files. Every article links back to its original source. No opinion. No editorial spin.
            </p>
            <a
              href="/about"
              class="inline-block mt-3 text-xs font-semibold text-accent hover:text-primary transition-colors"
            >
              Learn more &rarr;
            </a>
          </div>
        </aside>
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-text-muted text-lg font-serif">No articles yet.</p>
        <p class="text-text-muted text-sm mt-2">
          The automated pipeline will populate this section with news from major outlets.
        </p>
      </div>
    )}
  </section>
</BaseLayout>
